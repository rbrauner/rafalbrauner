services:
    caddy:
        container_name: rafalbrauner-caddy
        build:
            context: .
            dockerfile: ./docker/caddy/Dockerfile
            target: dev
            network: host
            args:
                TZ: ${TZ:-Europe/Warsaw}
                USER: ${APP_USER:-app}
                GROUP: ${APP_GROUP:-app}
                UID: ${UID:-1000}
                GID: ${GID:-1000}
        restart: unless-stopped
        working_dir: /var/www/html
        # user: "${UID:-1000}:${GID:-1000}"
        networks:
            shared-network:
        volumes:
            - caddy-data:/data
            - caddy-config:/config
            # - shared-home:/home/${APP_USER:-app}
            - .:/var/www/html
            - ./docker/caddy/dev/Caddyfile:/etc/caddy/Caddyfile
        labels:
            # caddy: "${DOMAIN:-rafalbrauner.localhost}"
            # caddy.reverse_proxy: "{{upstreams http}}"
            traefik.enable: true
            traefik.http.services.rafalbrauner.loadbalancer.server.port: 80
            traefik.http.services.rafalbrauner-secure.loadbalancer.server.port: 443
            traefik.http.services.rafalbrauner-vite.loadbalancer.server.port: 5173
            traefik.http.routers.rafalbrauner.rule: Host(`${DOMAIN:-rafalbrauner.localhost}`)
            traefik.http.routers.rafalbrauner.entrypoints: http
            traefik.http.routers.rafalbrauner.tls: false
            traefik.http.routers.rafalbrauner.service: rafalbrauner
            traefik.http.routers.rafalbrauner-secure.rule: Host(`${DOMAIN:-rafalbrauner.localhost}`)
            traefik.http.routers.rafalbrauner-secure.entrypoints: https
            traefik.http.routers.rafalbrauner-secure.tls: true
            traefik.http.routers.rafalbrauner-secure.service: rafalbrauner-secure
            traefik.http.routers.rafalbrauner-vite.rule: Host(`${DOMAIN:-rafalbrauner.localhost}`)
            traefik.http.routers.rafalbrauner-vite.entrypoints: vite
            traefik.http.routers.rafalbrauner-vite.tls: false
            traefik.http.routers.rafalbrauner-vite.service: rafalbrauner-vite

    php:
        container_name: rafalbrauner-php
        build:
            context: .
            dockerfile: ./docker/php/Dockerfile
            target: dev
            network: host
            args:
                TZ: ${TZ:-Europe/Warsaw}
                USER: ${APP_USER:-app}
                GROUP: ${APP_GROUP:-app}
                UID: ${UID:-1000}
                GID: ${GID:-1000}
        restart: unless-stopped
        working_dir: /var/www/html
        user: "${UID:-1000}:${GID:-1000}"
        # environment:
        #     XDEBUG_SESSION: 1
        networks:
            shared-network:
        volumes:
            - shared-home:/home/${APP_USER:-app}
            - .:/var/www/html
            - ./docker/php/dev/php.ini:/usr/local/etc/php/php.ini

    node:
        container_name: rafalbrauner-node
        build:
            context: .
            dockerfile: ./docker/node/Dockerfile
            target: dev
            network: host
            args:
                TZ: ${TZ:-Europe/Warsaw}
                USER: ${APP_USER:-app}
                GROUP: ${APP_GROUP:-app}
                UID: ${UID:-1000}
                GID: ${GID:-1000}
        restart: unless-stopped
        working_dir: /var/www/html
        user: "${UID:-1000}:${GID:-1000}"
        tty: true
        networks:
            shared-network:
        volumes:
            - shared-home:/home/${APP_USER:-app}
            - .:/var/www/html
            - ./docker/node/dev/startup.sh:/usr/local/bin/startup.sh

networks:
    shared-network:
        name: ${SHARED_NETWORK_NAME:-shared-network}
        external: true

volumes:
    shared-home:
        name: ${SHARED_HOME_VOLUME:-shared-home}
        external: true
    caddy-data:
        name: rafalbrauner-caddy-data
    caddy-config:
        name: rafalbrauner-caddy-config
