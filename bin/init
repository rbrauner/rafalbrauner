#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * Copyright (C) RafaÅ‚ Brauner
 */

$env = getenv('ENV') ?: 'dev';

if ('dev' === $env) {
    echo "> Initializing dev environment...\n";
    echo '> Press Enter to continue...';
    fgets(STDIN);

    if (!file_exists('.env')) {
        echo "> Creating \".env\" file from \".env.example-dev\"...\n";
        copy('.env.example-dev', '.env');
    } else {
        echo "> \".env\" file already exists. Skipping creation...\n";
    }

    if (!file_exists('compose.yaml')) {
        echo "> Creating \"compose.yaml\" from \"compose.example-dev.yaml\"...\n";
        copy('compose.example-dev.yaml', 'compose.yaml');
    } else {
        echo "> \"compose.yaml\" file already exists. Skipping creation...\n";
    }

    echo '> Check the created files + create docker network (ex. "docker network create shared-network") and press Enter to continue...';
    fgets(STDIN);

    echo "> Starting Docker containers...\n";
    exec('docker compose up -d');

    echo "> Installing PHP dependencies using Composer...\n";
    exec('docker compose exec -it php bash -c "composer install"');

    // echo "> Creating database, running migrations and loading fixtures...\n";
    // exec('docker compose exec -it php bash -c "php -d memory_limit=-1 bin/console doctrine:database:create --if-not-exists"');
    // exec('docker compose exec -it php bash -c "php -d memory_limit=-1 bin/console doctrine:migrations:migrate --no-interaction"');
    // exec('docker compose exec -it php bash -c "php -d memory_limit=-1 bin/console doctrine:fixtures:load --append --no-interaction"');

    echo "> Dev environment initialized successfully!\n";
} elseif ('prod' === $env) {
    echo "> Initializing prod environment...\n";
    echo '> Nothing to do...';
    echo "> Prod environment initialized successfully!\n";
} else {
    echo "> Unknown environment: {$env}\n";

    exit(1);
}
